<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>SwipeNotes ‚Äî Flashcard Notepad</title>

<!-- Firebase (Firestore) SDKs -->
<!-- Replace the firebaseConfig below with your own Firebase project config.
     This app uses Firestore for online storage & realtime sync. Works from static hosts (tiiny.host). -->
<script src="https://www.gstatic.com/firebasejs/9.28.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.28.0/firebase-firestore-compat.js"></script>

<style>
  :root{
    --bg:#0f1724;
    --card-bg:linear-gradient(135deg,#0b1220 0%, #0f1724 100%);
    --glass: rgba(255,255,255,0.04);
    --muted: rgba(255,255,255,0.6);
    --accent: #7c5cff;
    --green:#16a34a;
    --blue:#0ea5e9;
    --danger:#ef4444;
    --card-radius:16px;
    --shadow: 0 6px 20px rgba(2,6,23,0.6);
    font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
  }
  html,body{height:100%;margin:0;background:
    radial-gradient(1200px 800px at 10% 10%, rgba(124,92,255,0.08), transparent 6%),
    linear-gradient(180deg,#09101a 0%, #071021 60%);
    color: #e6eef8; -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;}
  .app{
    max-width:1100px;margin:32px auto;padding:24px;display:flex;gap:24px;
    align-items:stretch;min-height:calc(100vh - 64px);
  }

  /* Left column (controls + add note + trash + import/export + chat) */
  .left{
    width:360px; min-width:300px;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
    border-radius:18px;padding:18px;box-shadow:var(--shadow);backdrop-filter: blur(6px);
    display:flex;flex-direction:column;gap:12px;
  }
  .brand{display:flex;align-items:center;gap:12px}
  .logo{
    width:46px;height:46px;border-radius:10px;background:linear-gradient(135deg,var(--accent),#4ed8c4);
    display:flex;align-items:center;justify-content:center;font-weight:700;color:#021;box-shadow:0 6px 18px rgba(124,92,255,0.12);
  }
  h1{font-size:20px;margin:0}
  p.lead{margin:0;color:var(--muted);font-size:13px}

  .control-row{display:flex;gap:8px;align-items:center}
  .btn{
    background:linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.01));
    border:1px solid rgba(255,255,255,0.04);padding:8px 12px;border-radius:10px;color:inherit;font-weight:600;
    cursor:pointer;display:inline-flex;gap:8px;align-items:center;
  }
  .btn.ghost{background:transparent;border:1px dashed rgba(255,255,255,0.04)}
  .btn.red{background:linear-gradient(180deg,#541212,#2b0e0e);color:#ffdede;border:1px solid rgba(255,255,255,0.02)}
  .spacer{flex:1}

  .add-form{display:flex;flex-direction:column;gap:8px}
  .field{display:flex;flex-direction:column;gap:6px}
  input[type="text"], textarea, input[type="file"]{
    background:transparent;border:1px solid rgba(255,255,255,0.04);padding:10px;border-radius:10px;color:inherit;font-size:14px;
  }
  textarea{min-height:90px;resize:vertical}
  .colors{display:flex;gap:8px}
  .pill{padding:6px 10px;border-radius:999px;background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.02);cursor:pointer}
  .pill.active{box-shadow:0 6px 12px rgba(0,0,0,0.35);transform:translateY(-2px);}
  .trash-list{background:rgba(0,0,0,0.18);padding:8px;border-radius:10px;max-height:220px;overflow:auto}

  /* Right ‚Äî card swipe area */
  .right{flex:1;display:flex;flex-direction:column;gap:12px}
  .topbar{
    display:flex;align-items:center;gap:12px;justify-content:space-between;
    background:var(--glass);padding:12px;border-radius:12px;border:1px solid rgba(255,255,255,0.02)
  }
  .profile-pill{display:flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px}
  .profile-dot{width:14px;height:14px;border-radius:999px}
  .stack{position:relative;flex:1;display:flex;align-items:center;justify-content:center;min-height:420px}
  .card{
    width:100%;max-width:540px;height:380px;background:var(--card-bg);border-radius:var(--card-radius);
    padding:20px;box-shadow:var(--shadow);position:absolute;display:flex;flex-direction:column;justify-content:space-between;
    transition:transform 180ms ease,opacity 180ms ease;touch-action:none;user-select:none;will-change:transform,opacity;
    border:1px solid rgba(255,255,255,0.03);
  }
  .card .meta{display:flex;align-items:center;justify-content:space-between;gap:8px}
  .title{font-size:20px;font-weight:700}
  .desc{color:var(--muted);margin-top:10px;line-height:1.4}
  .bottomrow{display:flex;align-items:center;justify-content:space-between;gap:8px}
  .chip{padding:8px 10px;border-radius:999px;background:rgba(255,255,255,0.02);font-weight:600}
  .actions{display:flex;gap:8px;align-items:center}
  .like{display:inline-flex;gap:6px;align-items:center;padding:8px 10px;border-radius:999px;background:rgba(255,255,255,0.02);cursor:pointer}
  .new-badge{background:#ffef6b;color:#0b1220;padding:6px 8px;border-radius:999px;font-weight:700}
  .trash-icon{width:28px;height:28px;border-radius:8px;background:rgba(255,255,255,0.02);display:flex;align-items:center;justify-content:center;cursor:pointer}

  /* small screens */
  @media (max-width:900px){
    .app{flex-direction:column;padding:12px}
    .left{width:100%;min-width:unset;order:2}
    .right{order:1}
    .stack{min-height:64vh}
    .card{height:60vh;max-width:100%;border-radius:14px}
  }

  /* chatbox */
  .chat{
    position:fixed;right:18px;bottom:18px;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
    border-radius:12px;padding:12px;width:320px;max-width:90vw;box-shadow:0 10px 30px rgba(0,0,0,0.6);
  }
  .chat-messages{max-height:220px;overflow:auto;margin-bottom:8px;display:flex;flex-direction:column;gap:8px}
  .bubble{padding:8px 12px;border-radius:12px;background:rgba(255,255,255,0.03);font-size:14px}

  /* login overlay */
  .overlay{
    position:fixed;inset:0;background:linear-gradient(90deg,rgba(1,4,12,0.85),rgba(2,6,23,0.95));display:flex;align-items:center;justify-content:center;z-index:9999;
  }
  .login{
    width:420px;max-width:92vw;background:linear-gradient(180deg,#071021,#081223);border-radius:12px;padding:18px;border:1px solid rgba(255,255,255,0.03);
  }
  .profiles{display:flex;gap:12px;margin-top:12px}
  .profile-card{flex:1;padding:12px;border-radius:12px;display:flex;flex-direction:column;align-items:center;gap:8px;cursor:pointer;border:1px solid rgba(255,255,255,0.02)}
  .profile-card.active{box-shadow:0 10px 30px rgba(0,0,0,0.5);transform:translateY(-4px)}
  .small-muted{font-size:13px;color:var(--muted)}
  .tiny{font-size:12px;color:var(--muted)}
  .import-input{display:none}
  .toast{position:fixed;left:50%;transform:translateX(-50%);bottom:88px;background:#101827;padding:8px 14px;border-radius:8px;border:1px solid rgba(255,255,255,0.03)}
</style>
</head>
<body>
<div class="app" id="app" aria-hidden="true">
  <div class="left">
    <div class="brand">
      <div class="logo">SN</div>
      <div>
        <h1>SwipeNotes</h1>
        <p class="lead">Quick swipe flashcards + lasting memory. Synced across devices.</p>
      </div>
    </div>

    <div class="top-controls control-row">
      <div class="profile-pill" id="profileInfo">
        <div class="profile-dot" id="profileDot" style="background:var(--green)"></div>
        <div id="profileName">User 1</div>
      </div>
      <div class="spacer"></div>
      <div class="trash-icon btn ghost" id="openTrash" title="Open trash">üóëÔ∏è</div>
    </div>

    <div class="add-form" aria-label="Add new note">
      <div class="field">
        <label class="tiny">Title</label>
        <input id="noteTitle" type="text" placeholder="Short title e.g. 'Meeting tip'">
      </div>
      <div class="field">
        <label class="tiny">Description</label>
        <textarea id="noteDesc" placeholder="Write the advice or note..."></textarea>
      </div>

      <div style="display:flex;gap:8px;align-items:center;justify-content:space-between">
        <div class="colors" id="colorPills">
          <div class="pill active" data-color="green" id="pillGreen" style="border:2px solid rgba(22,163,74,0.12)">Green</div>
          <div class="pill" data-color="blue" id="pillBlue" style="border:2px solid rgba(14,165,233,0.08)">Blue</div>
        </div>
        <button class="btn" id="addBtn">Add note</button>
      </div>
    </div>

    <div style="display:flex;gap:8px;align-items:center;justify-content:space-between;margin-top:6px">
      <div class="small-muted">Import / Export</div>
      <div style="display:flex;gap:8px">
        <label class="btn ghost" for="importFile">Import</label>
        <input id="importFile" class="import-input" type="file" accept="application/json">
        <button class="btn" id="exportBtn">Export</button>
      </div>
    </div>

    <div style="margin-top:8px">
      <div class="small-muted">Trashed notes</div>
      <div class="trash-list" id="trashList">
        <div class="tiny" style="padding:8px;color:var(--muted)">Trash is empty</div>
      </div>
    </div>

    <div style="margin-top:auto">
      <div style="display:flex;gap:8px;align-items:center;justify-content:space-between">
        <div class="tiny">Sync status: <span id="syncStatus" class="tiny">Disconnected</span></div>
        <div class="tiny">Host: tiiny.host compatible</div>
      </div>
    </div>
  </div>

  <div class="right">
    <div class="topbar">
      <div style="display:flex;gap:12px;align-items:center">
        <div class="chip" id="countNotes">0 notes</div>
        <div class="chip" id="countNew">0 new</div>
        <div class="chip" id="countLikes">0 total likes</div>
      </div>
      <div style="display:flex;gap:10px;align-items:center">
        <div class="tiny">Swipe through notes</div>
        <div class="btn red" id="discardBtn">Discard (trash)</div>
      </div>
    </div>

    <div class="stack" id="stack" aria-live="polite">
      <!-- Cards injected here -->
      <div style="text-align:center;color:var(--muted)" id="emptyHint">No notes yet ‚Äî add one on the left ‚ú®</div>
    </div>

    <div style="display:flex;gap:12px;align-items:center;justify-content:center">
      <button class="btn ghost" id="prevBtn">‚óÄÔ∏é Prev (undo swipe)</button>
      <div style="display:flex;gap:8px">
        <div class="btn" id="skipLeft">Discard</div>
        <div class="btn" id="skipRight">Keep (Next)</div>
      </div>
      <button class="btn ghost" id="nextBtn">Next ‚ñ∂Ô∏é</button>
    </div>
  </div>
</div>

<!-- Chatbox -->
<div class="chat" id="chatBox" hidden>
  <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px">
    <div style="font-weight:700">Notes Chat</div>
    <div style="font-size:12px;color:var(--muted)">Simple reminders</div>
  </div>
  <div class="chat-messages" id="chatMessages"></div>
  <div style="display:flex;gap:8px">
    <input id="chatInput" type="text" placeholder="Type a short reminder..." style="flex:1;padding:8px;border-radius:10px;background:transparent;border:1px solid rgba(255,255,255,0.04);color:inherit">
    <button class="btn" id="chatSend">Send</button>
  </div>
</div>


<div id="toast" class="toast" style="display:none"></div>

<script>
/*
  SwipeNotes ‚Äî Single-file HTML app using Firebase Firestore for realtime sync.
  Replace firebaseConfig with your Firebase project's config object below.

  Data model (Firestore):
  Collection: notes
    doc fields:
      title: string
      desc: string
      color: "green" | "blue"
      createdAt: timestamp (server)
      trashed: boolean
      likes: number
      swipedBy: array of profile ids who have swiped this note (["1","2"])
      ownerProfile: "1" | "2" (creator profile)
  Collection: chat (for simple reminders)
    doc fields:
      text: string
      createdAt: timestamp
      profile: "1" | "2"
*/

////////////////////////////////////////////////////////////////////////////////
// CONFIG ‚Äî replace the firebaseConfig object with your own project's details //
////////////////////////////////////////////////////////////////////////////////
const firebaseConfig = {
  apiKey: "REPLACE_WITH_YOUR_API_KEY",
  authDomain: "REPLACE_WITH_YOUR_AUTH_DOMAIN",
  projectId: "REPLACE_WITH_YOUR_PROJECT_ID",
  storageBucket: "REPLACE_WITH_YOUR_BUCKET",
  messagingSenderId: "REPLACE_WITH_SENDER_ID",
  appId: "REPLACE_WITH_APP_ID"
};
// Firestore initialization
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

////////////////////////////////////////////////////////////////////////////////
// Basic state
////////////////////////////////////////////////////////////////////////////////
let currentProfile = "1"; // "1" (green) or "2" (blue)
let currentProfileName = { "1": "User 1", "2": "User 2" };
let profileColors = { "1": "green", "2": "blue" };
let notesCache = []; // local snapshot of notes (ordered newest first)
let cardStack = [];  // currently displayed DOM cards order
let lastSwipedStack = []; // for undo
let unsubNotes = null;
let unsubChat = null;
const PASSWORD = "productivity";

////////////////////////////////////////////////////////////////////////////////
// UI helpers
////////////////////////////////////////////////////////////////////////////////
const el = id => document.getElementById(id);
const toast = (txt, t=2500) => {
  const to = el('toast'); to.textContent = txt; to.style.display='block';
  clearTimeout(to._t); to._t = setTimeout(()=> to.style.display='none', t);
}

function setSyncStatus(connected){
  el('syncStatus').textContent = connected ? 'Connected' : 'Disconnected';
  el('syncStatus').style.color = connected ? '#b7f5d5' : 'var(--muted)';
}

function updateProfileUI(){
  el('profileDot').style.background = currentProfile === '1' ? 'var(--green)' : 'var(--blue)';
  el('profileName').textContent = currentProfileName[currentProfile];
  // color pill selection
  document.querySelectorAll('.pill').forEach(p=>{
    p.classList.toggle('active', p.dataset.color === profileColors[currentProfile]);
  });
}

////////////////////////////////////////////////////////////////////////////////
// Authentication gate (client-side password)
////////////////////////////////////////////////////////////////////////////////
el('unlockBtn').addEventListener('click', tryUnlock);
el('passwordInput').addEventListener('keydown', e=>{ if(e.key==='Enter') tryUnlock(); });
document.querySelectorAll('.profile-card').forEach(card=>{
  card.addEventListener('click', ()=> {
    document.querySelectorAll('.profile-card').forEach(c=>c.classList.remove('active'));
    card.classList.add('active');
    currentProfile = card.dataset.user;
  });
});

function tryUnlock(){
  const val = el('passwordInput').value;
  if(val === PASSWORD){
    el('loginOverlay').style.display = 'none';
    document.getElementById('app').removeAttribute('aria-hidden');
    updateProfileUI();
    startRealtime();
    el('chatBox').hidden = false;
    toast('Unlocked ‚Äî Welcome!');
  } else {
    toast('Wrong password.');
  }
}

////////////////////////////////////////////////////////////////////////////////
// Firestore realtime listeners & sync
////////////////////////////////////////////////////////////////////////////////
function startRealtime(){
  // Listen for notes (not trashed)
  unsubNotes = db.collection('notes')
    .orderBy('createdAt','desc')
    .onSnapshot(snapshot=>{
      setSyncStatus(true);
      notesCache = [];
      snapshot.forEach(doc=>{
        const data = doc.data();
        data.id = doc.id;
        notesCache.push(data);
      });
      renderAll();
    }, err=>{
      console.error('Notes listener error', err);
      setSyncStatus(false);
    });

  // chat listener
  unsubChat = db.collection('chat').orderBy('createdAt','asc').limit(200).onSnapshot(snap=>{
    const chatEl = el('chatMessages');
    chatEl.innerHTML = '';
    snap.forEach(doc=>{
      const d = doc.data();
      const b = document.createElement('div');
      b.className='bubble';
      b.style.alignSelf = d.profile === currentProfile ? 'flex-end' : 'flex-start';
      b.textContent = (d.profile==='1'?'üü¢ ':'üîµ ') + d.text;
      chatEl.appendChild(b);
    });
    chatEl.scrollTop = chatEl.scrollHeight;
  }, err=>{
    console.error('Chat listener error', err);
  });
}

////////////////////////////////////////////////////////////////////////////////
// Add new note
////////////////////////////////////////////////////////////////////////////////
el('addBtn').addEventListener('click', async ()=>{
  const title = el('noteTitle').value.trim();
  const desc = el('noteDesc').value.trim();
  if(!title && !desc) { toast('Add title or description'); return; }
  const color = profileColors[currentProfile] || 'green';
  try{
    await db.collection('notes').add({
      title, desc, color, trashed:false, likes:0, ownerProfile:currentProfile,
      createdAt: firebase.firestore.FieldValue.serverTimestamp(),
      swipedBy: []
    });
    el('noteTitle').value=''; el('noteDesc').value='';
    toast('Note added');
  }catch(e){ console.error(e); toast('Failed to add note'); }
});

////////////////////////////////////////////////////////////////////////////////
// Color pill selection (per current profile)
////////////////////////////////////////////////////////////////////////////////
document.querySelectorAll('.pill').forEach(p=>{
  p.addEventListener('click', ()=>{
    const c = p.dataset.color;
    profileColors[currentProfile] = c;
    updateProfileUI();
    p.classList.add('active');
  });
});

////////////////////////////////////////////////////////////////////////////////
// Render notes stack
////////////////////////////////////////////////////////////////////////////////
function renderAll(){
  // Exclude trashed notes from main stack
  const visible = notesCache.filter(n => !n.trashed);
  el('countNotes').textContent = visible.length + ' notes';
  const newCount = visible.reduce((acc,n)=> acc + ((n.swipedBy && n.swipedBy.indexOf(currentProfile)===-1) ? 1:0), 0);
  el('countNew').textContent = newCount + ' new';
  const totalLikes = visible.reduce((a,b)=>a + (b.likes||0),0);
  el('countLikes').textContent = totalLikes + ' total likes';

  const stackEl = el('stack');
  stackEl.innerHTML = '';
  if(visible.length===0){
    el('emptyHint').style.display='block';
    return;
  } else el('emptyHint').style.display='none';

  // Build cards top-first (so first item is top of stack)
  visible.forEach((note, idx)=>{
    const card = createCard(note, idx);
    // Slight offset for depth
    card.style.zIndex = (visible.length - idx);
    card.style.transform = `scale(${1 - idx*0.02}) translateY(${idx*8}px)`;
    stackEl.appendChild(card);
  });

  // store stack DOM order
  cardStack = Array.from(stackEl.querySelectorAll('.card'));
  // Attach swipe listeners to top card
  attachTopCardListeners();
  renderTrashList();
}

function createCard(note, idx){
  const c = document.createElement('div');
  c.className='card';
  c.dataset.id = note.id;
  c.innerHTML = `
    <div>
      <div class="meta">
        <div class="title">${escapeHtml(note.title || 'Untitled')}</div>
        <div style="display:flex;gap:8px;align-items:center">
          ${((!note.swipedBy || note.swipedBy.indexOf(currentProfile)===-1) ? '<div class="new-badge">NEW</div>' : '')}
          <div class="chip">${escapeHtml(note.color || '')}</div>
        </div>
      </div>
      <div class="desc">${escapeHtml(note.desc || '')}</div>
    </div>
    <div class="bottomrow">
      <div style="display:flex;gap:8px;align-items:center">
        <div class="like" title="Like">
          <span style="font-weight:700" data-likes>${note.likes||0}</span> ‚ù§Ô∏è
        </div>
        <div class="chip tiny">${note.ownerProfile==='1' ? 'üü¢ User1' : 'üîµ User2'}</div>
      </div>
      <div class="actions">
        <div class="chip tiny">swiped: ${(note.swipedBy||[]).length}</div>
        <div class="trash-icon" title="Discard">üóëÔ∏è</div>
      </div>
    </div>
  `;
  // color accent
  const color = note.color === 'blue' ? 'linear-gradient(135deg,#8ed8ff,#0ea5e9)' : 'linear-gradient(135deg,#7ef0b9,#16a34a)';
  c.style.background = `${color}`;
  c.style.color = '#021';
  c.style.border = '1px solid rgba(0,0,0,0.06)';
  c.style.boxShadow = '0 10px 30px rgba(0,0,0,0.5)';

  // attach like and trash handlers
  c.querySelector('.like').addEventListener('click', async (e)=>{
    e.stopPropagation();
    const id = c.dataset.id;
    try{
      const ref = db.collection('notes').doc(id);
      await db.runTransaction(async tx=>{
        const doc = await tx.get(ref);
        if(!doc.exists) return;
        const cur = doc.data().likes || 0;
        tx.update(ref, { likes: cur + 1 });
      });
      toast('Liked');
    }catch(err){ console.error(err); toast('Failed to like'); }
  });

  c.querySelector('.trash-icon').addEventListener('click', (e)=>{
    e.stopPropagation();
    discardNote(c.dataset.id);
  });

  return c;
}

function attachTopCardListeners(){
  const top = cardStack[0];
  if(!top) return;
  let startX=0, startY=0, currentX=0, currentY=0, dragging=false;
  const threshold = 120;

  function onStart(e){
    dragging = true;
    startX = (e.touches ? e.touches[0].clientX : e.clientX);
    startY = (e.touches ? e.touches[0].clientY : e.clientY);
    top.style.transition = 'none';
  }
  function onMove(e){
    if(!dragging) return;
    currentX = (e.touches ? e.touches[0].clientX : e.clientX) - startX;
    currentY = (e.touches ? e.touches[0].clientY : e.clientY) - startY;
    const rot = currentX/10;
    top.style.transform = `translate(${currentX}px, ${currentY}px) rotate(${rot}deg)`;
    top.style.opacity = `${1 - Math.min(0.6, Math.abs(currentX)/600)}`;
  }
  function onEnd(){
    if(!dragging) return;
    dragging=false;
    top.style.transition = 'transform 220ms ease, opacity 220ms ease';
    if(Math.abs(currentX) > threshold){
      // swipe out
      const toRight = currentX > 0;
      const finalX = (toRight ? 1000 : -1000);
      top.style.transform = `translate(${finalX}px, ${currentY}px) rotate(${toRight ? 40 : -40}deg)`;
      top.style.opacity = '0';
      const id = top.dataset.id;
      // mark swiped for current profile
      markSwiped(id);
      // push to lastSwipedStack for undo
      lastSwipedStack.unshift({id, direction: toRight ? 'right' : 'left'});
      // remove from DOM after animation
      setTimeout(()=> {
        // remove doc from stack and re-render minor transform adjustments
        top.remove();
        cardStack.shift();
        // apply new styles to remaining cards
        cardStack.forEach((c, i)=> c.style.transform = `scale(${1 - i*0.02}) translateY(${i*8}px)`);
        attachTopCardListeners();
      }, 260);
    } else {
      // return
      top.style.transform = '';
      top.style.opacity = '1';
    }
    currentX=0; currentY=0;
  }

  top.addEventListener('pointerdown', onStart);
  window.addEventListener('pointermove', onMove);
  window.addEventListener('pointerup', onEnd);
  top.addEventListener('touchstart', onStart,{passive:true});
  top.addEventListener('touchmove', onMove,{passive:true});
  top.addEventListener('touchend', onEnd);
}

////////////////////////////////////////////////////////////////////////////////
// Swipe actions (next / discard / undo)
////////////////////////////////////////////////////////////////////////////////
el('skipRight').addEventListener('click', ()=> programmaticSwipe(true));
el('skipLeft').addEventListener('click', ()=> programmaticSwipe(false));
el('discardBtn').addEventListener('click', ()=> {
  const t = cardStack[0];
  if(!t) return;
  discardNote(t.dataset.id);
  // animate removal
  t.style.transition = 'transform 260ms ease, opacity 260ms ease';
  t.style.transform = 'translate(-900px, 0) rotate(-20deg)';
  t.style.opacity = '0';
  setTimeout(()=>{ t.remove(); cardStack.shift(); attachTopCardListeners(); }, 280);
});
el('nextBtn').addEventListener('click', ()=> programmaticSwipe(true));
el('prevBtn').addEventListener('click', undoLastSwipe);

async function programmaticSwipe(toRight = true){
  const top = cardStack[0];
  if(!top) return;
  top.style.transition = 'transform 260ms ease, opacity 260ms ease';
  top.style.transform = `translate(${toRight ? 900 : -900}px, 0) rotate(${toRight ? 25 : -25}deg)`;
  top.style.opacity = '0';
  markSwiped(top.dataset.id);
  lastSwipedStack.unshift({id: top.dataset.id, direction: toRight ? 'right' : 'left'});
  setTimeout(()=>{ top.remove(); cardStack.shift(); attachTopCardListeners(); }, 280);
}

async function markSwiped(id){
  // add currentProfile to swipedBy if not present
  try{
    const ref = db.collection('notes').doc(id);
    await db.runTransaction(async tx=>{
      const d = await tx.get(ref);
      if(!d.exists) return;
      const cur = d.data().swipedBy || [];
      if(cur.indexOf(currentProfile) === -1){
        const n = [...cur, currentProfile];
        tx.update(ref, { swipedBy: n });
      }
    });
  }catch(e){ console.error(e); }
}

async function discardNote(id){
  try{
    await db.collection('notes').doc(id).update({ trashed:true });
    toast('Moved to trash');
  }catch(e){ console.error(e); toast('Failed to trash'); }
}

async function undoLastSwipe(){
  const last = lastSwipedStack.shift();
  if(!last){ toast('Nothing to undo'); return; }
  // remove currentProfile from swipedBy for that note
  try{
    const ref = db.collection('notes').doc(last.id);
    await db.runTransaction(async tx=>{
      const d = await tx.get(ref);
      if(!d.exists) return;
      const cur = d.data().swipedBy || [];
      const idx = cur.indexOf(currentProfile);
      if(idx !== -1) cur.splice(idx,1);
      tx.update(ref, { swipedBy: cur });
    });
    toast('Undo swipe');
  }catch(e){ console.error(e); toast('Undo failed'); }
}

////////////////////////////////////////////////////////////////////////////////
// Trash list rendering & recover
////////////////////////////////////////////////////////////////////////////////
function renderTrashList(){
  const trashed = notesCache.filter(n => n.trashed);
  const tl = el('trashList');
  tl.innerHTML = '';
  if(trashed.length === 0){
    tl.innerHTML = `<div class="tiny" style="padding:8px;color:var(--muted)">Trash is empty</div>`;
    return;
  }
  trashed.forEach(n=>{
    const row = document.createElement('div');
    row.style.display='flex';row.style.alignItems='center';row.style.justifyContent='space-between';
    row.style.padding='6px';row.style.borderRadius='8px';
    row.innerHTML = `<div style="display:flex;gap:8px;align-items:center">
        <div style="width:10px;height:10px;border-radius:20px;background:${n.color==='blue'?'var(--blue)':'var(--green)'}"></div>
        <div style="font-weight:700">${escapeHtml(n.title||'Untitled')}</div>
      </div>
      <div style="display:flex;gap:8px;align-items:center">
        <button class="btn ghost" data-id="${n.id}" data-action="recover">Recover</button>
        <button class="btn ghost" data-id="${n.id}" data-action="delete">Delete</button>
      </div>`;
    tl.appendChild(row);
    row.querySelector('[data-action="recover"]').addEventListener('click', ()=> recoverNote(n.id));
    row.querySelector('[data-action="delete"]').addEventListener('click', ()=> deleteNotePermanently(n.id));
  });
}

el('openTrash').addEventListener('click', ()=> {
  const tl = el('trashList');
  tl.scrollIntoView({behavior:'smooth',block:'center'});
  toast('Trash opened');
});

async function recoverNote(id){
  try{
    await db.collection('notes').doc(id).update({ trashed:false });
    toast('Recovered');
  }catch(e){ console.error(e); toast('Failed to recover'); }
}

async function deleteNotePermanently(id){
  if(!confirm('Delete permanently? This cannot be undone.')) return;
  try{
    await db.collection('notes').doc(id).delete();
    toast('Deleted permanently');
  }catch(e){ console.error(e); toast('Delete failed'); }
}

////////////////////////////////////////////////////////////////////////////////
// Import / Export (JSON)
////////////////////////////////////////////////////////////////////////////////
el('exportBtn').addEventListener('click', async ()=>{
  try{
    const snap = await db.collection('notes').get();
    const arr = [];
    snap.forEach(doc=>{
      const d = doc.data(); d.id = doc.id;
      // convert timestamps to ISO if present
      if(d.createdAt && d.createdAt.toDate) d.createdAt = d.createdAt.toDate().toISOString();
      arr.push(d);
    });
    const blob = new Blob([JSON.stringify(arr,null,2)], {type:'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = 'swipenotes-export.json';
    document.body.appendChild(a); a.click(); a.remove();
    URL.revokeObjectURL(url);
    toast('Export started');
  }catch(e){ console.error(e); toast('Export failed'); }
});

el('importFile').addEventListener('change', async (ev)=>{
  const f = ev.target.files[0]; if(!f) return;
  try{
    const txt = await f.text();
    const arr = JSON.parse(txt);
    if(!Array.isArray(arr)) throw new Error('Invalid format');
    // Ask user ‚Äî we won't ask; follow instructions: best-effort import
    const batch = db.batch();
    arr.forEach(item=>{
      // if item has id from previous app and you want to keep same id, we can set doc with that id.
      const id = item.id || db.collection('notes').doc().id;
      const ref = db.collection('notes').doc(id);
      // Convert createdAt ISO to serverTimestamp if missing
      if(item.createdAt && typeof item.createdAt === 'string'){
        try{ item.createdAt = new Date(item.createdAt); }
        catch(e){ item.createdAt = new Date(); }
      }
      // Set defaults
      const payload = {
        title: item.title || '',
        desc: item.desc || '',
        color: item.color || 'green',
        trashed: !!item.trashed,
        likes: item.likes || 0,
        ownerProfile: item.ownerProfile || '1',
        swipedBy: Array.isArray(item.swipedBy) ? item.swipedBy : [],
        createdAt: (item.createdAt instanceof Date) ? firebase.firestore.Timestamp.fromDate(item.createdAt) : firebase.firestore.FieldValue.serverTimestamp()
      };
      batch.set(ref, payload, { merge: true });
    });
    await batch.commit();
    toast('Imported notes');
  }catch(e){ console.error(e); toast('Import failed'); }
});

////////////////////////////////////////////////////////////////////////////////
// Chat (simple reminders)
////////////////////////////////////////////////////////////////////////////////
el('chatSend').addEventListener('click', sendChat);
el('chatInput').addEventListener('keydown', e=>{ if(e.key==='Enter') sendChat(); });

async function sendChat(){
  const txt = el('chatInput').value.trim();
  if(!txt) return;
  try{
    await db.collection('chat').add({ text: txt, profile: currentProfile, createdAt: firebase.firestore.FieldValue.serverTimestamp() });
    el('chatInput').value='';
  }catch(e){ console.error(e); toast('Failed to send'); }
}

////////////////////////////////////////////////////////////////////////////////
// Utilities
////////////////////////////////////////////////////////////////////////////////
function escapeHtml(s){
  if(!s) return '';
  return s.replace(/[&<>"']/g, function(m){
    return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]);
  });
}

// monitor connection state (best-effort)
window.addEventListener('online', ()=> setSyncStatus(true));
window.addEventListener('offline', ()=> setSyncStatus(false));

// minimal initialization of UI
updateProfileUI();

// When page unloads, detach listeners
window.addEventListener('beforeunload', ()=>{
  if(unsubNotes) unsubNotes();
  if(unsubChat) unsubChat();
});
</script>
  <script type="module">
  // Import the functions you need from the SDKs you need
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
  import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-analytics.js";
  // TODO: Add SDKs for Firebase products that you want to use
  // https://firebase.google.com/docs/web/setup#available-libraries

  // Your web app's Firebase configuration
  // For Firebase JS SDK v7.20.0 and later, measurementId is optional
  const firebaseConfig = {
    apiKey: "AIzaSyCgWmuOquxwwHCG2u6FNZrb-zrBics3HWk",
    authDomain: "notes-d7918.firebaseapp.com",
    projectId: "notes-d7918",
    storageBucket: "notes-d7918.firebasestorage.app",
    messagingSenderId: "136757169437",
    appId: "1:136757169437:web:809c9df7ff5aca5ea6e5f4",
    measurementId: "G-H54E8JGDFL"
  };

  // Initialize Firebase
  const app = initializeApp(firebaseConfig);
  const analytics = getAnalytics(app);
</script>
</body>
</html>
