<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FlashCard NotePad</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* [CSS VARIABLES] */
        :root { --color-green: #4CAF50; --color-blue: #2196F3; --color-red: #F44336; --color-dark: #333; --color-light: #f9f9f9; --color-bg: #ececec; --border-radius: 12px; --shadow: 0 4px 12px rgba(0, 0, 0, 0.1); }
        /* [GLOBAL STYLES & BODY] */
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Inter', sans-serif; }
        body { background-color: var(--color-bg); display: flex; justify-content: center; align-items: center; min-height: 100vh; overflow: hidden; }
        /* [LOGIN SCREEN] */
        #login-screen { display: flex; flex-direction: column; align-items: center; justify-content: center; width: 100%; max-width: 400px; padding: 20px; background: white; border-radius: var(--border-radius); box-shadow: var(--shadow); }
        .profile-btn { width: 100%; padding: 15px; margin-top: 15px; border: none; border-radius: var(--border-radius); color: white; font-size: 1.1em; cursor: pointer; transition: transform 0.2s; }
        .profile-btn:hover { transform: scale(1.02); }
        .profile-green { background-color: var(--color-green); }
        .profile-blue { background-color: var(--color-blue); }
        /* [MAIN APP CONTAINER] */
        #app-container { display: none; flex-direction: column; width: 100%; max-width: 500px; height: 90vh; background: white; border-radius: var(--border-radius); box-shadow: var(--shadow); position: relative; padding: 20px; }
        /* [CARD STYLES] */
        #flashcard-wrapper { position: relative; flex-grow: 1; display: flex; justify-content: center; align-items: center; padding: 20px 0; }
        #flashcard { width: 100%; height: 100%; background: var(--color-light); border-radius: var(--border-radius); padding: 25px; box-shadow: var(--shadow); display: flex; flex-direction: column; justify-content: space-between; transition: transform 0.3s ease-out, opacity 0.3s ease-out; border-left: 8px solid; }
        .swipe-out { transform: translateX(-100%) rotate(-5deg); opacity: 0; }
        .note-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px; padding-left: 10px; border-left: 4px solid; }
        .card-title { font-size: 1.5rem; font-weight: bold; color: var(--color-dark); }
        .card-description { flex-grow: 1; font-size: 1.1rem; line-height: 1.6; color: #555; overflow-y: auto; padding-right: 5px; }
        .new-tag { background-color: var(--color-red); color: white; padding: 4px 8px; border-radius: 9999px; font-size: 0.7rem; font-weight: bold; margin-left: 10px; align-self: center; }
        .card-footer { display: flex; justify-content: space-between; align-items: center; margin-top: 15px; font-size: 0.9em; color: #888; }
        /* [CONTROLS] */
        #note-controls { display: flex; justify-content: space-around; padding-top: 20px; border-top: 1px solid #eee; }
        .control-btn { padding: 12px 20px; border-radius: 9999px; font-weight: bold; cursor: pointer; transition: background-color 0.2s, transform 0.1s; }
        .control-btn:active { transform: scale(0.98); }
        .btn-swipe { background-color: var(--color-blue); color: white; }
        .btn-discard { background-color: var(--color-red); color: white; }
        .btn-like { background-color: #ddd; color: var(--color-dark); }
        .btn-like.liked { background-color: #FFC0CB; color: var(--color-red); }
        /* [MODALS] */
        .modal { display: none; position: fixed; z-index: 100; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.4); justify-content: center; align-items: center; }
        .modal-content { background-color: white; padding: 25px; border-radius: var(--border-radius); box-shadow: var(--shadow); width: 90%; max-width: 450px; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .modal-close { color: #aaa; font-size: 28px; font-weight: bold; cursor: pointer; transition: color 0.2s; }
        .modal-close:hover, .modal-close:focus { color: var(--color-dark); }
        input[type="text"], textarea { width: 100%; padding: 10px; margin: 10px 0; border: 1px solid #ccc; border-radius: var(--border-radius); resize: vertical; }
        .form-btn { background-color: var(--color-green); color: white; padding: 10px 20px; border: none; border-radius: var(--border-radius); cursor: pointer; margin-top: 10px; }
        /* [TRASH MODAL] */
        #trash-list li { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid #eee; }
        #trash-list li:last-child { border-bottom: none; }
        .recover-btn, .delete-btn { padding: 5px 10px; margin-left: 10px; border: none; border-radius: 5px; cursor: pointer; font-size: 0.8em; }
        .recover-btn { background-color: var(--color-blue); color: white; }
        .delete-btn { background-color: var(--color-red); color: white; }
        /* [UTILITY BUTTONS] */
        .utility-btn { position: absolute; width: 40px; height: 40px; background: var(--color-dark); color: white; border-radius: 9999px; display: flex; justify-content: center; align-items: center; font-size: 1.5rem; cursor: pointer; box-shadow: var(--shadow); transition: transform 0.2s, background 0.2s; z-index: 50; }
        .utility-btn:hover { background: #555; }
        #add-btn { bottom: 20px; right: 20px; }
        #trash-btn { top: 20px; right: 20px; }
        #tools-btn { top: 20px; left: 20px; background: var(--color-green); font-size: 1.1rem;}
        /* [CHAT BOX] */
        #chat-box-container { position: fixed; bottom: 20px; right: 20px; width: 300px; max-height: 400px; z-index: 100; display: none; flex-direction: column; background: white; border-radius: var(--border-radius); box-shadow: var(--shadow); }
        #chat-header { background: var(--color-dark); color: white; padding: 10px; border-top-left-radius: var(--border-radius); border-top-right-radius: var(--border-radius); font-weight: bold; cursor: pointer; }
        #chat-messages { flex-grow: 1; padding: 10px; overflow-y: auto; max-height: 300px; border-bottom: 1px solid #eee; }
        .chat-message { margin-bottom: 5px; padding: 5px 8px; border-radius: 8px; font-size: 0.9em; }
        .message-green { background-color: #e6ffe6; border-left: 4px solid var(--color-green); }
        .message-blue { background-color: #e6f0ff; border-left: 4px solid var(--color-blue); }
        #chat-form { display: flex; padding: 10px; }
        #chat-input { flex-grow: 1; padding: 8px; border: 1px solid #ccc; border-radius: 8px; margin-right: 8px; }
        #chat-send-btn { background-color: var(--color-blue); color: white; padding: 8px 15px; border-radius: 8px; }
        #chat-toggle-btn { position: fixed; bottom: 20px; right: 20px; }
        #chat-minimize { display: none; }
        /* [TOOLS MODAL] */
        .tools-section { margin-bottom: 20px; padding: 15px; border: 1px solid #eee; border-radius: var(--border-radius); }
    </style>
</head>
<body>
    <script type="module">
        // [FIREBASE IMPORTS & INITIALIZATION]
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, query, onSnapshot, updateDoc, arrayUnion, arrayRemove, deleteDoc, orderBy } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";
        const firebaseConfig = {apiKey: "AIzaSyCgWmuOquxwwHCG2u6FNZrb-zrBics3HWk", authDomain: "notes-d7918.firebaseapp.com", projectId: "notes-d7918", storageBucket: "notes-d7918.firebasestorage.app", messagingSenderId: "136757169437", appId: "1:136757169437:web:809c9df7ff5aca5ea6e5f4", measurementId: "G-H54E8JGDFL"};
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        let currentUserId = null; let currentUserProfile = null; let notes = []; let trashNotes = []; let currentNoteIndex = 0;

        // [USER PROFILE & AUTH LOGIC]
        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUserId = user.uid;
                const userRef = doc(db, "users", currentUserId);
                // Check if profile exists in Firestore, otherwise use the stored local profile from selection
                onSnapshot(userRef, (docSnap) => {
                    if (docSnap.exists() && docSnap.data().profile) {
                        currentUserProfile = docSnap.data().profile;
                    }
                    if (currentUserProfile) {
                        document.getElementById('login-screen').style.display = 'none';
                        document.getElementById('app-container').style.display = 'flex';
                        document.getElementById('chat-toggle-btn').style.display = 'flex';
                        fetchUserNotes();
                        setupChatListener();
                    }
                });
            } else if (auth.currentUser) {
                 // Logged in but profile isn't set yet (or fresh anonymous user)
            } else {
                document.getElementById('login-screen').style.display = 'flex';
                document.getElementById('app-container').style.display = 'none';
                document.getElementById('chat-box-container').style.display = 'none';
                document.getElementById('chat-toggle-btn').style.display = 'none';
                currentUserId = null; currentUserProfile = null;
            }
        });
        window.selectProfile = async (profile) => {
            currentUserProfile = profile;
            try {
                const userCredential = await signInAnonymously(auth);
                const userRef = doc(db, "users", userCredential.user.uid);
                await setDoc(userRef, { profile: profile, uid: userCredential.user.uid });
            } catch (error) { console.error("Login/Profile Error: ", error); }
        };

        // [NOTES LOGIC: FETCHING, DISPLAYING, ACTIONS]
        const fetchUserNotes = () => {
            const notesCollection = collection(db, "notes");
            const q = query(notesCollection, orderBy("timestamp", "desc"));
            onSnapshot(q, (snapshot) => {
                const activeNotes = []; const trashed = [];
                snapshot.docs.forEach(doc => {
                    const noteData = { id: doc.id, ...doc.data() };
                    if (noteData.isTrashed) {
                        trashed.push(noteData);
                    } else {
                        activeNotes.push(noteData);
                    }
                });
                // Check if current note is still in the active list
                const currentNoteId = notes[currentNoteIndex]?.id;
                notes = activeNotes;
                trashNotes = trashed;
                const newIndex = notes.findIndex(n => n.id === currentNoteId);

                if (newIndex === -1 && notes.length > 0) {
                    currentNoteIndex = 0; // Reset to start if current note was deleted/trashed
                } else if (notes.length === 0) {
                    currentNoteIndex = 0; // No notes
                } else if (newIndex !== -1) {
                    currentNoteIndex = newIndex; // Keep the index if the note is found
                }
                renderCurrentNote();
                renderTrashNotes();
            });
        };
        const renderCurrentNote = () => {
            const cardElement = document.getElementById('flashcard');
            const note = notes[currentNoteIndex];
            if (!note) {
                cardElement.innerHTML = '<h2 class="card-title">No Notes Yet!</h2><p class="card-description">Add your first note using the + button.</p>';
                cardElement.style.borderColor = 'gray';
                document.getElementById('note-controls').style.display = 'none';
                return;
            }
            document.getElementById('note-controls').style.display = 'flex';
            const color = note.profile === 'green' ? 'var(--color-green)' : 'var(--color-blue)';
            cardElement.innerHTML = `
                <div class="note-header" style="border-left-color: ${color};">
                    <h2 class="card-title">${note.title}</h2>
                    ${note.isNew ? '<span class="new-tag">NEW</span>' : ''}
                </div>
                <p class="card-description">${note.description}</p>
                <div class="card-footer">
                    <span class="like-count">${note.likes?.length || 0} ❤️</span>
                    <span class="note-profile" style="color: ${color};">Profile: ${note.profile}</span>
                </div>
            `;
            cardElement.style.borderColor = color;
            updateLikeButton(note);
        };
        window.swipeNext = async () => {
            const currentNote = notes[currentNoteIndex];
            if (currentNote && currentNote.isNew) {
                // Mark as swiped/read
                await updateDoc(doc(db, "notes", currentNote.id), { isNew: false });
            }
            const cardElement = document.getElementById('flashcard');
            cardElement.classList.add('swipe-out');
            setTimeout(() => {
                if (notes.length > 0) {
                    currentNoteIndex = (currentNoteIndex + 1) % notes.length;
                } else {
                    currentNoteIndex = 0;
                }
                renderCurrentNote();
                cardElement.classList.remove('swipe-out');
            }, 300);
        };
        window.discardNote = async () => {
            const currentNote = notes[currentNoteIndex];
            if (currentNote) {
                await updateDoc(doc(db, "notes", currentNote.id), { isTrashed: true, trashedBy: currentUserId, trashedAt: new Date().getTime() });
                // The index adjustment and re-render will be handled automatically by fetchUserNotes/onSnapshot
            }
            // Move on to the next one, which handles the rendering
            const cardElement = document.getElementById('flashcard');
            cardElement.classList.add('swipe-out');
            setTimeout(() => {
                cardElement.classList.remove('swipe-out');
            }, 300);
        };
        window.addNote = async () => {
            const title = document.getElementById('new-note-title').value;
            const description = document.getElementById('new-note-description').value;
            if (title && description && currentUserProfile) {
                await setDoc(doc(db, "notes", `note_${new Date().getTime()}_${Math.random().toString(36).substring(2, 9)}`), {
                    title, description, profile: currentUserProfile, userId: currentUserId, isTrashed: false, isNew: true, likes: [], timestamp: new Date().getTime()
                });
                document.getElementById('new-note-title').value = '';
                document.getElementById('new-note-description').value = '';
                window.toggleModal('add-note-modal');
            }
        };

        // [LIKES FUNCTION]
        const updateLikeButton = (note) => {
            const likeBtn = document.getElementById('like-btn');
            if (!note || !likeBtn) return;
            const isLiked = note.likes && note.likes.includes(currentUserId);
            likeBtn.textContent = isLiked ? '❤️ Liked (Unlike)' : 'Like Note';
            isLiked ? likeBtn.classList.add('liked') : likeBtn.classList.remove('liked');
        };
        window.toggleLike = async () => {
            const currentNote = notes[currentNoteIndex];
            if (!currentNote || !currentUserId) return;
            const noteRef = doc(db, "notes", currentNote.id);
            const isLiked = currentNote.likes?.includes(currentUserId);
            if (isLiked) { await updateDoc(noteRef, { likes: arrayRemove(currentUserId) }); }
            else { await updateDoc(noteRef, { likes: arrayUnion(currentUserId) }); }
        };

        // [TRASH & RECOVER LOGIC]
        const renderTrashNotes = () => {
            const list = document.getElementById('trash-list');
            list.innerHTML = '';
            if (trashNotes.length === 0) { list.innerHTML = '<p style="text-align: center; color: var(--color-dark); padding: 10px;">Trash is empty.</p>'; return; }
            trashNotes.forEach(note => {
                const li = document.createElement('li');
                li.innerHTML = `
                    <span style="flex-grow: 1;">${note.title}</span>
                    <button onclick="recoverNote('${note.id}')" class="recover-btn">Recover</button>
                    <button onclick="deleteNote('${note.id}')" class="delete-btn">Delete</button>
                `;
                list.appendChild(li);
            });
        };
        window.recoverNote = async (noteId) => { await updateDoc(doc(db, "notes", noteId), { isTrashed: false, trashedBy: null, trashedAt: null }); };
        window.deleteNote = async (noteId) => {
            if (confirm("Permanently delete this note?")) { await deleteDoc(doc(db, "notes", noteId)); }
        };

        // [IMPORT/EXPORT LOGIC]
        window.exportNotes = () => {
            const exportData = [...notes, ...trashNotes].map(({ id, title, description, profile, userId, likes }) => ({ title, description, profile, userId, likes: likes || [] }));
            const dataStr = JSON.stringify(exportData, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,' + encodeURIComponent(dataStr);
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', 'flashcard_notes_export.json');
            linkElement.click();
        };
        window.importNotes = () => { document.getElementById('import-file').click(); };
        window.handleImport = (event) => {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    const importedNotes = JSON.parse(e.target.result);
                    if (!Array.isArray(importedNotes)) throw new Error("Invalid file format.");
                    for (const note of importedNotes) {
                        if (!note.title || !note.description) continue;
                        const noteId = `note_${new Date().getTime()}_${Math.random().toString(36).substring(2, 9)}`;
                        await setDoc(doc(db, "notes", noteId), {
                            title: note.title, description: note.description,
                            profile: note.profile || currentUserProfile, userId: note.userId || currentUserId,
                            isTrashed: false, isNew: true, likes: note.likes || [],
                            timestamp: new Date().getTime()
                        });
                    }
                    alert(`Successfully imported ${importedNotes.length} notes.`);
                } catch (error) { console.error("Error importing notes: ", error); alert("Error importing notes. Check console for details."); }
            };
            reader.readAsText(file);
        };

        // [CHAT LOGIC]
        const setupChatListener = () => {
            const messagesRef = collection(db, "chat");
            const q = query(messagesRef, orderBy("timestamp", "asc"));
            onSnapshot(q, (snapshot) => {
                const chatBox = document.getElementById('chat-messages');
                chatBox.innerHTML = '';
                snapshot.docs.forEach(doc => {
                    const msg = doc.data();
                    const messageElement = document.createElement('div');
                    messageElement.classList.add('chat-message');
                    messageElement.classList.add(msg.profile === 'green' ? 'message-green' : 'message-blue');
                    messageElement.innerHTML = `<strong>${msg.profile}:</strong> ${msg.text}`;
                    chatBox.appendChild(messageElement);
                });
                chatBox.scrollTop = chatBox.scrollHeight;
            });
        };
        window.sendChat = async (event) => {
            event.preventDefault();
            const input = document.getElementById('chat-input');
            const text = input.value.trim();
            if (text && currentUserProfile) {
                await setDoc(doc(db, "chat", `msg_${new Date().getTime()}_${Math.random().toString(36).substring(2, 9)}`), {
                    text, profile: currentUserProfile, userId: currentUserId, timestamp: new Date().getTime()
                });
                input.value = '';
            }
        };

        // [UTILITY FUNCTIONS]
        window.toggleModal = (id) => {
            const modal = document.getElementById(id);
            modal.style.display = modal.style.display === 'flex' ? 'none' : 'flex';
        };
        window.toggleChat = () => {
            const chatBox = document.getElementById('chat-box-container');
            const chatMin = document.getElementById('chat-minimize');
            if (chatBox.style.display === 'flex') {
                chatBox.style.display = 'none';
                chatMin.style.display = 'flex';
            } else {
                chatBox.style.display = 'flex';
                chatMin.style.display = 'none';
                document.getElementById('chat-messages').scrollTop = document.getElementById('chat-messages').scrollHeight;
            }
        }
    </script>

    <!-- [LOGIN SCREEN] -->
    <div id="login-screen" class="absolute inset-0 z-50 bg-gray-50 flex-col">
        <h1 class="text-2xl font-bold mb-6 text-gray-800">Select Your Profile</h1>
        <p class="text-sm text-gray-600 mb-6">This sets the color-coding for your notes.</p>
        <button class="profile-btn profile-green" onclick="selectProfile('green')">Green Profile</button>
        <button class="profile-btn profile-blue" onclick="selectProfile('blue')">Blue Profile</button>
    </div>

    <!-- [MAIN APP CONTAINER] -->
    <div id="app-container" class="relative">
        <div class="flex justify-between items-center w-full mb-4">
            <div id="tools-btn" class="utility-btn !relative !w-auto !h-auto !px-4 !py-2" onclick="toggleModal('tools-modal')" title="Tools">⚙️ Tools</div>
        </div>

        <!-- Utility Buttons -->
        <div id="trash-btn" class="utility-btn top-5 right-5" onclick="toggleModal('trash-modal')" title="Trash">🗑️</div>
        
        <!-- Flashcard Wrapper -->
        <div id="flashcard-wrapper">
            <div id="flashcard">
                <!-- Content will be rendered by JavaScript -->
                <h2 class="card-title">Loading Notes...</h2>
                <p class="card-description">Please wait while we connect to the database.</p>
            </div>
        </div>

        <!-- Note Controls -->
        <div id="note-controls" class="flex justify-between items-center w-full">
            <button id="discard-btn" class="control-btn btn-discard flex-1 mr-2" onclick="discardNote()">Discard</button>
            <button id="like-btn" class="control-btn btn-like" onclick="toggleLike()">Like Note</button>
            <button id="swipe-btn" class="control-btn btn-swipe flex-1 ml-2" onclick="swipeNext()">Next Note &gt;</button>
        </div>

        <!-- Add Note Button -->
        <div id="add-btn" class="utility-btn" onclick="toggleModal('add-note-modal')" title="Add Note">+</div>
    </div>

    <!-- [ADD NOTE MODAL] -->
    <div id="add-note-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="text-xl font-bold">Add New Note/Flashcard</h2>
                <span class="modal-close" onclick="toggleModal('add-note-modal')">&times;</span>
            </div>
            <input type="text" id="new-note-title" placeholder="Title (e.g., Key Concept 1)">
            <textarea id="new-note-description" placeholder="Description/Advice (e.g., Remember to use active voice in all essays)" rows="5"></textarea>
            <button class="form-btn" onclick="addNote()">Save Note</button>
        </div>
    </div>

    <!-- [TRASH MODAL] -->
    <div id="trash-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="text-xl font-bold">Trash Can (Trashed Notes)</h2>
                <span class="modal-close" onclick="toggleModal('trash-modal')">&times;</span>
            </div>
            <ul id="trash-list">
                <!-- Trashed notes rendered here -->
            </ul>
        </div>
    </div>
    
    <!-- [TOOLS MODAL - Import/Export] -->
    <div id="tools-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="text-xl font-bold">Data Management Tools</h2>
                <span class="modal-close" onclick="toggleModal('tools-modal')">&times;</span>
            </div>
            
            <div class="tools-section">
                <h3 class="font-semibold mb-2">Export Notes (Backup)</h3>
                <p class="text-sm mb-3 text-gray-600">Exports all active and trashed notes to a single JSON file.</p>
                <button class="form-btn !bg-gray-500" onclick="exportNotes()">Download JSON Export</button>
            </div>
            
            <div class="tools-section">
                <h3 class="font-semibold mb-2">Import Notes</h3>
                <p class="text-sm mb-3 text-gray-600">Import notes from a previously exported JSON file.</p>
                <input type="file" id="import-file" accept=".json" onchange="handleImport(event)" style="display: none;">
                <button class="form-btn !bg-purple-600" onclick="importNotes()">Select JSON File to Import</button>
            </div>
        </div>
    </div>

    <!-- [CHAT BOX] -->
    <div id="chat-box-container" class="fixed right-5 bottom-20 shadow-xl" style="display: none;">
        <div id="chat-header" onclick="toggleChat()">Simple Reminders Chat (Click to Minimize)</div>
        <div id="chat-messages">
            <!-- Messages rendered by JS -->
        </div>
        <form id="chat-form" onsubmit="sendChat(event)">
            <input type="text" id="chat-input" placeholder="Type a reminder..." required>
            <button id="chat-send-btn" type="submit">Send</button>
        </form>
    </div>
    
    <!-- Chat Minimize Button -->
    <div id="chat-minimize" class="utility-btn !bg-blue-600 fixed right-5 bottom-5" onclick="toggleChat()" title="Open Chat">💬</div>

</body>
</html>
